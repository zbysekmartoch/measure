# Labs Feature Specification

## Overview

Labs are the core organizational unit in Measure. Each lab represents an analysis project with its own scripts, results, and settings. Labs are stored on disk (not in the database) and support multi-user sharing.

---

## Data Model

### Disk Structure

```
backend/labs/<id>/
├── lab.json          # Lab metadata (name, description, owner, shared users)
├── scripts/          # User scripts (Python, R, JS, SQL, Shell, workflows)
├── results/          # Execution results (numbered subfolders)
│   ├── 1/
│   │   ├── status.json   # Execution status, timing, steps
│   │   ├── stdout.log    # Script stdout
│   │   ├── stderr.log    # Script stderr
│   │   └── ...           # Output files generated by the script
│   └── 2/
└── state/            # Per-user UI state (selected file, expanded folders, etc.)
    └── <userId>.json
```

### `lab.json` Format

```json
{
  "name": "Price Analysis",
  "description": "Analyze pricing trends across categories",
  "owner": 5,
  "sharedWith": [3, 7],
  "created": "2025-01-15T10:30:00.000Z",
  "updated": "2025-02-01T14:22:00.000Z"
}
```

### Result `status.json` Format

```json
{
  "status": "completed",
  "file": "analyze.py",
  "startedAt": "2025-02-01T14:22:00.000Z",
  "completedAt": "2025-02-01T14:22:35.000Z",
  "steps": [
    { "step": 1, "label": "Loading data", "time": 2.1 },
    { "step": 2, "label": "Processing", "time": 28.3 },
    { "step": 3, "label": "Generating report", "time": 4.6 }
  ]
}
```

---

## Backend API

All endpoints require JWT authentication. Access is restricted to lab owner and users listed in `sharedWith`.

### Lab CRUD

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/labs` | List labs owned by current user |
| GET | `/api/v1/labs/shared` | List labs shared with current user |
| POST | `/api/v1/labs` | Create a new lab |
| PUT | `/api/v1/labs/:id` | Update lab metadata (name, description) |
| DELETE | `/api/v1/labs/:id` | Delete lab and all its data (owner only) |

### Sharing

| Method | Endpoint | Description |
|--------|----------|-------------|
| PUT | `/api/v1/labs/:id/share` | Update shared user list |

### Per-User State

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/labs/:id/state` | Get user's UI state for this lab |
| PUT | `/api/v1/labs/:id/state` | Save user's UI state |

### Scripts (File Management)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/labs/:id/scripts` | List script files (tree) |
| GET | `/api/v1/labs/:id/scripts/content?file=...` | Read file content |
| PUT | `/api/v1/labs/:id/scripts/content` | Save file content (creates parent dirs) |
| POST | `/api/v1/labs/:id/scripts/upload` | Upload a file |
| POST | `/api/v1/labs/:id/scripts/folder` | Create a new folder |
| GET | `/api/v1/labs/:id/scripts/download?file=...` | Download a file |
| DELETE | `/api/v1/labs/:id/scripts?file=...` | Delete a file |
| DELETE | `/api/v1/labs/:id/scripts/folder?path=...` | Delete a folder recursively |
| GET | `/api/v1/labs/:id/scripts/folder/zip?path=...` | Download folder as ZIP |

### Script Execution

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/labs/:id/scripts/run` | Execute a script (SSE response with progress) |
| POST | `/api/v1/labs/:id/scripts/debug` | Start a debug session |

### Results

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/labs/:id/results` | List all results |
| GET | `/api/v1/labs/:id/results/:resultId` | Get result details + file list |
| DELETE | `/api/v1/labs/:id/results/:resultId` | Delete a result |
| POST | `/api/v1/labs/:id/results/:resultId/reset` | Reset result (re-run) |

### Result Files

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/labs/:id/results/:resultId/files` | List result files |
| GET | `/api/v1/labs/:id/results/:resultId/files/content?file=...` | Read result file |
| GET | `/api/v1/labs/:id/results/:resultId/files/download?file=...` | Download result file |
| DELETE | `/api/v1/labs/:id/results/:resultId/files?file=...` | Delete result file |

### Debug

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/labs/:id/debug/status` | Get debug session status |
| POST | `/api/v1/labs/:id/debug/end` | End debug session |
| GET | `/api/v1/labs/:id/debug/events` | SSE stream of debug events |

### Cross-Root Paste

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/paste` | Copy file/folder between different labs or file roots |

---

## Frontend UI

### Lab Browser (`LabsTab`)

Two sub-tabs:
- **My Labs** — create, delete, select, and open labs
- **Shared Labs** — browse labs shared by other users

Clicking "Enter" on a lab opens it as a new sub-tab.

### Lab Workspace (`LabWorkspaceTab`)

Each opened lab gets a dynamic sub-tab with three panes:

| Pane | Component | Description |
|------|-----------|-------------|
| **Scripts** | `LabScriptsPane` | File manager for scripts + Run / Debug buttons |
| **Results** | `LabResultsPane` | Result list + file viewer for selected result |
| **Settings** | `LabSettingsPane` | Lab name, description, sharing configuration |

### Scripts Pane

- Dual-pane file manager (tree browser + preview/editor)
- Run button executes the selected script via SSE
- Debug button starts a DAP debug session
- Workflow files (`.workflow`) get a special debug button

### Results Pane

- Dropdown to select a result by ID
- Status display (Completed / Running / Failed / Pending)
- Timing information (per-step and total)
- File browser for result output files
- Reset button to re-run a result

---

## Security

- Access checks on every endpoint: lab owner or `sharedWith` user
- Path traversal protection on all file operations
- Owner-only operations: delete lab
- Script execution is sandboxed to the lab's directory

---

## Script Execution Details

Scripts are executed as child processes. The command is determined by file extension via `config.json`:

```json
{
  "scripts": {
    "commands": {
      ".py": "labs/.venv/bin/python",
      ".js": "node",
      ".sh": "bash",
      ".r": "Rscript",
      ".R": "Rscript"
    }
  }
}
```

Results are stored in sequentially numbered subfolders (`results/1/`, `results/2/`, etc.) with stdout/stderr logs and any files generated by the script.

Progress is reported via SSE (Server-Sent Events) with step updates, allowing the frontend to display real-time execution progress.
